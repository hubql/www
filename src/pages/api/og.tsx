import satori from 'satori'
import { Resvg, initWasm } from '@resvg/resvg-wasm'
import Image from 'next/image'

let wasmInitialized = false

async function initResvg() {
    if (!wasmInitialized) {
        // Fetch WASM for Node.js runtime
        const wasmModule = await fetch(
            'https://unpkg.com/@resvg/resvg-wasm/index_bg.wasm'
        ).then((res) => res.arrayBuffer())
        await initWasm(wasmModule)
        wasmInitialized = true
    }
}

export default async function handler(req: any, res: any) {
    try {
        const { searchParams } = new URL(req.url)

        // ?title=<title>
        const hasTitle = searchParams.has('title')
        const title = hasTitle
            ? searchParams.get('title')?.slice(0, 100)
            : 'Your vision brought to life.'

        // Initialize resvg WASM
        await initResvg()

        // Fetch font for Satori
        const fontData = await fetch(
            'https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff'
        ).then((res) => res.arrayBuffer())

        // Generate SVG using Satori
        const svg = await satori(
            <div
                style={{
                    backgroundColor: 'black',
                    backgroundSize: '150px 150px',
                    height: '100%',
                    width: '100%',
                    display: 'flex',
                    textAlign: 'center',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexDirection: 'column',
                    flexWrap: 'nowrap',
                    position: 'relative',
                }}
            >
                <Image
                    alt="Hubql"
                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='675' viewBox='0 0 1200 675' fill='none'%3E%3Cg  clipPath='url(%23clip0_1_462)'%3E%3Crect width='1200' height='675' fill='%2318181B'/%3E%3Crect x='-63.5' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='45.4177' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='154.336' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='263.253' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='372.171' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='481.089' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='590.006' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='698.924' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='807.842' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='916.76' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1025.68' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1134.6' y='-70.5' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='-63.5' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='45.4177' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='154.336' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='263.253' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='372.171' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='481.089' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='590.006' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='698.924' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='807.842' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='916.76' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1025.68' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1134.6' y='38.4178' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='-63.5' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='45.4177' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='154.336' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='263.253' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='372.171' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='481.089' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='590.006' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='698.924' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='807.842' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='916.76' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1025.68' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1134.6' y='147.336' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='-63.5' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='45.4177' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='154.336' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='263.253' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='372.171' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='481.089' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='590.006' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='698.924' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='807.842' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='916.76' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1025.68' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1134.6' y='256.253' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='-63.5' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='45.4177' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='154.336' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='263.253' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='372.171' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='481.089' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='590.006' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='698.924' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='807.842' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='916.76' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1025.68' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1134.6' y='365.171' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='-63.5' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='45.4177' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='154.336' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='263.253' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='372.171' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='481.089' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='590.006' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='698.924' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='807.842' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='916.76' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1025.68' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1134.6' y='474.089' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='-63.5' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='45.4177' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='154.336' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='263.253' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='372.171' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='481.089' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='590.006' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='698.924' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='807.842' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='916.76' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1025.68' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Crect x='1134.6' y='583.006' width='101.918' height='101.918' rx='16.5' stroke='%2327272A'/%3E%3Cpath d='M478 127.5V55C478 43.9543 469.046 35 458 35H344.5H274.5C263.454 35 254.5 26.0457 254.5 15V0' stroke='%2322C55E' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M1201.5 362H1042.5C1031.45 362 1022.5 370.954 1022.5 382V450.5C1022.5 461.546 1013.55 470.5 1002.5 470.5H928' stroke='%2322C55E' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M1059 31.5H933.5C922.454 31.5 913.5 40.4543 913.5 51.5V124C913.5 135.046 904.546 144 893.5 144H820.5' stroke='%2322C55E' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M243 471H62.5C51.4543 471 42.5 462.046 42.5 451V383C42.5 371.954 33.5457 363 22.5 363H0' stroke='%2322C55E' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M695.5 675V600C695.5 588.954 686.546 580 675.5 580H607C595.954 580 587 571.046 587 560V490' stroke='%2322C55E' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3Crect width='1200' height='675' fill='url(%23paint0_radial_1_462)'/%3E%3Cpath d='M547.985 317.889C549.926 315.056 552.28 312.833 555.047 311.219C557.85 309.605 560.977 308.799 564.427 308.799C567.481 308.799 570.285 309.265 572.836 310.197C575.387 311.094 577.579 312.51 579.412 314.447C581.245 316.383 582.664 318.875 583.671 321.924C584.713 324.936 585.234 328.576 585.234 332.843V368.076H570.248V332.736C570.248 330.655 569.979 328.863 569.44 327.357C568.936 325.85 568.2 324.631 567.23 323.698C566.259 322.766 565.091 322.085 563.726 321.654C562.36 321.189 560.815 320.955 559.09 320.955C556.574 320.955 554.382 321.403 552.513 322.3C550.681 323.197 549.171 324.452 547.985 326.065V368.076H533V285.453H547.985V317.889ZM632.082 359.9C630.106 362.805 627.715 365.082 624.913 366.732C622.145 368.381 619.109 369.206 615.803 369.206C612.784 369.206 610.017 368.74 607.501 367.808C604.986 366.875 602.829 365.405 601.033 363.397C599.236 361.353 597.834 358.771 596.828 355.65C595.858 352.495 595.372 348.711 595.372 344.3V309.874H610.358V344.408C610.358 346.775 610.52 348.765 610.844 350.379C611.203 351.993 611.76 353.301 612.514 354.306C613.269 355.274 614.257 355.974 615.479 356.404C616.701 356.834 618.192 357.049 619.953 357.049C622.936 357.049 625.362 356.493 627.23 355.382C629.099 354.234 630.519 352.674 631.489 350.702V309.874H646.528V368.076H632.945L632.082 359.9ZM709.333 339.567C709.333 343.906 708.848 347.887 707.877 351.509C706.943 355.131 705.523 358.25 703.618 360.869C701.714 363.486 699.342 365.53 696.503 367C693.664 368.435 690.358 369.152 686.585 369.152C683.171 369.152 680.206 368.524 677.69 367.27C675.211 365.978 673.072 364.186 671.275 361.891L670.575 368.076H657.098V285.453H672.084V315.146C673.809 313.137 675.839 311.578 678.175 310.466C680.547 309.354 683.314 308.799 686.477 308.799C690.286 308.799 693.61 309.534 696.449 311.004C699.324 312.474 701.714 314.518 703.618 317.136C705.523 319.754 706.943 322.892 707.877 326.549C708.848 330.171 709.333 334.134 709.333 338.437V339.567ZM694.347 338.437C694.347 336.071 694.167 333.829 693.808 331.714C693.448 329.598 692.82 327.751 691.921 326.173C691.059 324.559 689.873 323.286 688.363 322.354C686.854 321.422 684.967 320.955 682.703 320.955C679.972 320.955 677.744 321.529 676.019 322.676C674.33 323.824 673.018 325.402 672.084 327.41V350.594C673.018 352.603 674.33 354.18 676.019 355.328C677.744 356.475 680.008 357.049 682.811 357.049C685.075 357.049 686.944 356.619 688.417 355.758C689.891 354.862 691.059 353.642 691.921 352.1C692.82 350.522 693.448 348.676 693.808 346.56C694.167 344.408 694.347 342.078 694.347 339.567V338.437ZM717.153 338.491C717.153 334.08 717.656 330.046 718.663 326.388C719.669 322.73 721.142 319.611 723.083 317.029C725.06 314.41 727.467 312.385 730.306 310.95C733.181 309.515 736.469 308.799 740.171 308.799C743.477 308.799 746.352 309.408 748.796 310.627C751.275 311.847 753.413 313.568 755.21 315.791L756.127 309.874H769.333V390.453H754.294V363.128C752.533 365.064 750.485 366.552 748.149 367.592C745.813 368.632 743.118 369.152 740.063 369.152C736.397 369.152 733.145 368.417 730.306 366.947C727.467 365.44 725.077 363.378 723.137 360.761C721.196 358.107 719.705 354.987 718.663 351.401C717.656 347.779 717.153 343.852 717.153 339.621V338.491ZM732.139 339.621C732.139 342.024 732.354 344.283 732.786 346.398C733.217 348.514 733.9 350.379 734.834 351.993C735.769 353.571 736.973 354.826 738.446 355.758C739.955 356.69 741.77 357.157 743.89 357.157C746.514 357.157 748.652 356.637 750.305 355.597C751.994 354.557 753.324 353.122 754.294 351.293V326.549C753.324 324.757 751.994 323.376 750.305 322.408C748.652 321.403 746.55 320.902 743.998 320.902C741.878 320.902 740.063 321.368 738.554 322.3C737.08 323.197 735.858 324.434 734.888 326.012C733.954 327.59 733.253 329.455 732.786 331.606C732.354 333.722 732.139 336.017 732.139 338.491V339.621ZM783.677 285.453H816.289V355.92H833V368.076H783.677V355.92H801.142V297.664H783.677V285.453Z' fill='white'/%3E%3Cpath d='M368 299.818C368 287.768 377.768 278 389.818 278H466.182C478.232 278 488 287.768 488 299.818V376.182C488 388.232 478.232 398 466.182 398H389.818C377.768 398 368 388.232 368 376.182V299.818Z' fill='%23000000'/%3E%3Cpath  fillRule='evenodd'  clipRule='evenodd' d='M461.382 296.545H394.618C390.16 296.545 386.545 300.16 386.545 304.618V371.382C386.545 375.84 390.16 379.455 394.618 379.455H461.382C465.84 379.455 469.455 375.84 469.455 371.382V304.618C469.455 300.16 465.84 296.545 461.382 296.545ZM394.618 290C386.545 290 380 296.545 380 304.618V371.382C380 379.455 386.545 386 394.618 386H461.382C469.455 386 476 379.455 476 371.382V304.618C476 296.545 469.455 290 461.382 290H394.618Z' fill='%23FFFFFF'/%3E%3Cpath d='M431.333 360.037C431.333 362.126 431.056 363.983 430.5 365.607C429.945 367.232 429.146 368.601 428.104 369.715C427.062 370.83 425.789 371.677 424.285 372.257C422.803 372.837 421.113 373.127 419.215 373.127C418.405 373.127 417.664 373.081 416.993 372.988C416.344 372.918 415.65 372.768 414.909 372.535L415.326 365.956C415.534 366.025 415.789 366.083 416.09 366.13C416.414 366.199 416.738 366.246 417.062 366.269C417.409 366.315 417.745 366.35 418.069 366.373C418.393 366.397 418.659 366.408 418.868 366.408C420.21 366.408 421.24 365.84 421.958 364.702C422.676 363.588 423.034 362.033 423.034 360.037V315.858C423.034 313.769 423.324 311.913 423.903 310.288C424.504 308.663 425.349 307.306 426.437 306.215C427.549 305.124 428.891 304.3 430.465 303.743C432.063 303.163 433.857 302.873 435.848 302.873C436.727 302.873 437.595 302.942 438.452 303.082C439.332 303.221 440.211 303.395 441.091 303.604L440.258 309.94C439.818 309.824 439.343 309.743 438.834 309.696C438.325 309.627 437.734 309.592 437.063 309.592C435.188 309.592 433.764 310.149 432.792 311.263C431.82 312.354 431.333 313.886 431.333 315.858V360.037Z' fill='%2322C55E'/%3E%3C/g%3E%3Cdefs%3E%3CradialGradient id='paint0_radial_1_462' cx='0' cy='0' r='1' gradientUnits='userSpaceOnUse' gradientTransform='translate(600 337.5) rotate(90) scale(337.5 600)'%3E%3Cstop offset='0.463542' stopColor='%2318181B' stop-opacity='0'/%3E%3Cstop offset='1' stopColor='%2318181B'/%3E%3C/radialGradient%3E%3CclipPath id='clip0_1_462'%3E%3Crect width='1200' height='675' fill='white'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E"
                    width={675}
                    height={400}
                    className="absolute mx-[30px]"
                />

                <div
                    style={{
                        fontSize:
                            title?.length && title?.length > 50
                                ? 30
                                : title?.length && title?.length > 30
                                ? 40
                                : 60,
                        fontStyle: 'normal',
                        letterSpacing: '-0.025em',
                        color: 'white',
                        marginTop: -250,
                        padding: '0 120px',
                        lineHeight: 1.2,
                        whiteSpace: 'pre-wrap',
                    }}
                >
                    {title}
                </div>
            </div>,
            {
                width: 1200,
                height: 630,
                fonts: [
                    {
                        name: 'Inter',
                        data: fontData,
                        weight: 400,
                        style: 'normal',
                    },
                ],
            }
        )

        // Convert SVG to PNG using resvg
        const resvg = new Resvg(svg, {
            fitTo: {
                mode: 'width',
                value: 1200,
            },
        })
        const pngData = resvg.render()
        const pngBuffer = pngData.asPng()

        res.setHeader('Content-Type', 'image/png')
        res.setHeader('Cache-Control', 'public, max-age=31536000, immutable')
        res.status(200).send(pngBuffer)
    } catch (e: any) {
        console.error(`${e.message}`)
        res.status(500).send('Failed to generate the image')
    }
}
